using Nancy.Extensions;

namespace Nancy
{
    using System;
    using System.Collections.Generic;
	using System.Collections.Specialized;
    using System.IO;
    using System.Linq;

    public interface IRequest
    {
        string Uri { get; }

        string Method { get; }

        IDictionary<string, IEnumerable<string>> Headers { get; }

        Stream Body { get; }

        dynamic Form { get; }

        dynamic Query { get; }

        string Protocol { get; }
		
		NameValueCollection QueryString { get ; }
    }

    public class Request : IRequest
    {
        private dynamic form;

        public Request(string method, string uri, string protocol, NameValueCollection queryString)
            : this(method, uri, new Dictionary<string, IEnumerable<string>>(), new MemoryStream(), protocol, queryString)
        {
        }

<<<<<<< /mnt/Vbox/FSTMerge/binary/fstmerge_tmp1390770913381/fstmerge_var1_4547390585317345904
        public Request(string method, string uri, IDictionary<string, IEnumerable<string>> headers, Stream body, string protocol, string query = "")
=======
        public Request(string method, string uri, IDictionary<string, IEnumerable<string>> headers, Stream body, string protocol, NameValueCollection queryString)
>>>>>>> /mnt/Vbox/FSTMerge/binary/fstmerge_tmp1390770913381/fstmerge_var2_9145731707463926590
        {
            if (method == null)
                throw new ArgumentNullException("method", "The value of the method parameter cannot be null.");
            
            if (method.Length == 0)
                throw new ArgumentOutOfRangeException("method", method, "The value of the method parameter cannot be empty.");

            if (uri == null)
                throw new ArgumentNullException("uri", "The value of the uri parameter cannot be null.");

            if (uri.Length == 0)
                throw new ArgumentOutOfRangeException("uri", uri, "The value of the uri parameter cannot be empty.");

            if (headers == null)
                throw new ArgumentNullException("headers", "The value of the headers parameter cannot be null.");

            if (body == null)
                throw new ArgumentNullException("body", "The value of the body parameter cannot be null.");

            if (protocol == null)
                throw new ArgumentNullException("protocol", "The value of the protocol parameter cannot be null.");

            if (protocol.Length == 0)
                throw new ArgumentOutOfRangeException("protocol", protocol, "The value of the protocol parameter cannot be empty.");

            this.Body = body;
            this.Headers = new Dictionary<string, IEnumerable<string>>(headers, StringComparer.OrdinalIgnoreCase);
            this.Method = method;
            this.Uri = uri;
            this.Protocol = protocol;
<<<<<<< /mnt/Vbox/FSTMerge/binary/fstmerge_tmp1390770913381/fstmerge_var1_4547390585317345904
            this.Query = query.AsQueryDictionary();
=======
			this.QueryString = queryString;
>>>>>>> /mnt/Vbox/FSTMerge/binary/fstmerge_tmp1390770913381/fstmerge_var2_9145731707463926590
        }

        public dynamic Query { get; set; }

        public Stream Body { get; set; }

        public dynamic Form
        {
            get { return this.form ?? (this.form = this.GetFormData()); }
        }

        private dynamic GetFormData()
        {
            if (this.Headers.Keys.Any(x => x.Equals("content-type", StringComparison.OrdinalIgnoreCase)))
            {
                var contentType = this.Headers["content-type"].First();
                if (contentType.Equals("application/x-www-form-urlencoded", StringComparison.OrdinalIgnoreCase))
                {
                    var reader = new StreamReader(this.Body);
                    return reader.ReadToEnd().AsQueryDictionary();
                }
            }
            return new DynamicDictionary();
        }

        public IDictionary<string, IEnumerable<string>> Headers { get; private set; }

        public string Method { get; private set; }

        public string Uri { get; private set; }

        public string Protocol { get; private set; }
		
		public NameValueCollection QueryString { get; private set; }
    }
}

